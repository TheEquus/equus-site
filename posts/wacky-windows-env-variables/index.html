<!doctype html><html lang=en data-mode=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=description content="A small dive into the weird world of Windows environment variables and how its odd behaviours can be abused to bypass application logic"><meta property="og:title" content="Wacky Windows Environment Variables"><meta property="og:description" content="A small dive into the weird world of Windows environment variables and how its odd behaviours can be abused to bypass application logic"><meta property="og:image" content="https:/anniequus.com/posts/wacky-windows-env-variables/media/cover.jpg"><meta property="og:url" content="https://anniequus.com/posts/wacky-windows-env-variables/"><title>Wacky Windows Environment Variables</title>
<link rel=canonical href=https://anniequus.com/posts/wacky-windows-env-variables/><link rel=preload href=https://anniequus.com/fonts/AnonymousPro-Regular.ttf as=font crossorigin=anonymous><link rel=preload href=https://anniequus.com/fonts/Heebo-VariableFont_wght.ttf as=font crossorigin=anonymous><link rel=preload href=https://anniequus.com/fonts/Rubik-VariableFont_wght.ttf as=font crossorigin=anonymous><link rel=stylesheet href=https://anniequus.com/css/main.min.438d8614614734b73815278dc3c64b0220335c8c5e5168baefe118fb203f84bb.css integrity="sha256-Q42GFGFHNLc4FSeNw8ZLAiAzXIxeUWi67+EY+yA/hLs=" crossorigin=anonymous><script defer src=https://anniequus.com/js/main.min.cf29f7226a9c2b2d20303d20e6fdd133796cbbd092dfd7486f2e01b089ffe03d.js integrity="sha256-zyn3ImqcKy0gMD0g5v3RM3lsu9CS39dIby4BsIn/4D0=" crossorigin=anonymous></script></head><body><header id=navbar><h1><a href=https://anniequus.com/>Equus üê¥ (Annie)</a></h1><ul><li><a href=/about/>About</a></li><li><a href=/posts/>Posts</a></li></ul></header><a href=# id=backtotop></a><div class=content><main><article><header><h1>Wacky Windows Environment Variables</h1><section class=terms><a class=btn href=/categories/random/>random</a><a class=btn href=/categories/windows/>Windows</a></section><p>Published on <time datetime=2023-11-05>2023-11-05</time></p></header><details class=toc open><summary class=outline-dashed>Table of Contents</summary><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a><ul><li><a href=#windows-environment-variables>Windows environment variables</a></li><li><a href=#the-code>The code</a></li></ul></li><li><a href=#figuring-out-windows-environment-variables>Figuring out Windows environment variables</a><ul><li><a href=#windows-environment-variable-behaviour-1>Windows environment variable behaviour #1</a></li><li><a href=#creating-schr√∂dingers-environment-variable>Creating Schr√∂dinger&rsquo;s environment variable</a></li></ul></li><li><a href=#bypassing-logic-to-get-admin>Bypassing logic to get admin</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></details><h2 id=introduction>Introduction</h2><p>Picture this - you&rsquo;ve been blessed with the task of dissecting a binary written in C++ that looks like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C++ data-lang=C++><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>using</span> <span style=color:#66d9ef>namespace</span> std;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>admin</span>() {
</span></span><span style=display:flex><span>    cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;There is no DEMO - signs of an admin!&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>user</span>() {
</span></span><span style=display:flex><span>    cout <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;I see a DEMO variable - signs of a regular user&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> check;
</span></span><span style=display:flex><span>    check <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;DEMO&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (check <span style=color:#f92672>!=</span> NULL) {
</span></span><span style=display:flex><span>        user();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span> 
</span></span><span style=display:flex><span>        admin();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>What is it even doing, and is it possible to get to admin without being an admin? This post will look into some interesting Windows environment variable behaviours, and how they can be used to bypass application logic.</p><h3 id=windows-environment-variables>Windows environment variables</h3><p>But first, what the heck are Windows environment variables? Basically, Windows environment variables store data that is then used by the operating system and applications. There are two types:</p><ul><li>User environment variables - environment variables that are set for each Windows user. These can be changed by the user; &</li><li>System environment variables - environment variables that are set for all users of the machine. These can only be changed by a user with administrator permissions on the machine.</li></ul><h3 id=the-code>The code</h3><p>Now to look at the glorious C++ program. Focusing on <code>check = getenv("DEMO")</code> first:
<img src=media/getenv.png alt="Reading C++ documentation to understand getenv" loading=lazy>
Accoding to <a href=https://en.cppreference.com/w/cpp/utility/program/getenv target=_blank rel=noreferrer>this C++ reference site</a>
, <code>getenv</code> searches the environment list provided by the OS and returns the value of the environment variable. But interestingly, it will return a null pointer if the variable doesn&rsquo;t exist. So essentially if there&rsquo;s an environment variable called <code>DEMO</code> in the environment variables, then the <code>user()</code> function will run (as <code>check != NULL</code> evaluates to true). Otherwise, <code>admin()</code> is run (as <code>getenv()</code> returns a NULL pointer).</p><h2 id=figuring-out-windows-environment-variables>Figuring out Windows environment variables</h2><p>Armed with the above knowledge, getting to the admin function should be pretty straightforward. As long as the environment variable doesn&rsquo;t exist in either the user or system environment variables list, then <code>admin()</code> will be executed. So if <code>DEMO</code> was set as a <strong>user environment variable</strong>, the user can just delete the user environment variable. But what happens if <code>DEMO</code> is set as a <strong>system environment variable</strong> and the user is not an admin of the machine?</p><h3 id=windows-environment-variable-behaviour-1>Windows environment variable behaviour #1</h3><p>After digging around for some formal documentation about environment variables from Microsoft, I cam across a <a href=https://web.archive.org/web/20111225045158/http://support.microsoft.com/kb/100843/EN-US target=_blank rel=noreferrer>very old piece of Windows documentation</a>
that had an extra bit of information not present in any current Microsoft documentation:
<img src=media/uservar.png alt="Old piece of Windows docs that is only viewable thanks to web archive" loading=lazy></p><ul><li>User environment variables take precedence over system environment variables</li></ul><p>What this means is that if a user and system environment variable both have the same name, the value of the user environment is used.</p><p>So using this knowledge, it&rsquo;s possible for the user to overwrite the value of the system environment variable. But just this alone isn&rsquo;t enough to call <code>admin()</code> as a low privileged user on the machine. Whilst we can control the value of <code>DEMO</code>, we still need <code>getenv</code> to return a NULL pointer. So is it possible to create a user environment variable that both exists (so that the user environment variable is used in place of the system environment variable), and doesn&rsquo;t exist (so that <code>getenv</code> returns a NULL pointer) <strong>at the same time</strong>?</p><h3 id=creating-schr√∂dingers-environment-variable>Creating Schr√∂dinger&rsquo;s environment variable</h3><p>This is where the wacky behaviour really sets in. Microsoft really lacks documentation about the inner workings and behaviours of Windows. But after some digging around, I came across an <a href=https://ss64.com/nt/setx.html target=_blank rel=noreferrer>awesome community managed reference guide</a>
with an interesting piece of information about environment variables:
<img src=media/deleteenv.png alt="Reference stating there are multiple ways of deleting an env variable, but using setx and an empty string works too" loading=lazy></p><ul><li>Setting a value of "" (empty quotes) will appear to delete the variable, it&rsquo;s not shown by SET but the variable name will remain in the registry.</li></ul><p>This tells us that using the <code>setx</code> command can delete an environment variable, but the variable still exists in the registry. Could this be the birth of Schr√∂dinger&rsquo;s environment variable?</p><h2 id=bypassing-logic-to-get-admin>Bypassing logic to get admin</h2><p>Time to put all the theory to the test.
<img src=media/env_start.png alt="Environment variable set up with DEMO as a system environment variable and there is no DEMO in the user environment variable" loading=lazy>
The above image is the initial set of environment variables of a machine. Note the user is a low privilege user, and can&rsquo;t make any edits to the system environment variable as the GUI options are grayed out.</p><p><img src=media/env_test.png alt="Testing the C++ code with the above environment variables set. The user function is executed as expected" loading=lazy>
And as expected, the user function is executed. Now to try running <code>setx DEMO ""</code> in command prompt to &ldquo;delete&rdquo; the DEMO variable.</p><p><img src=media/env_change.png alt="Creating the DEMO user environment variable with an empty string" loading=lazy>
Interestingly, the GUI interface for managing environment variables shows that <code>DEMO</code> exists as a user environment variable with no value. But the real question is, what will the program think?</p><p><img src=media/env_bypass.png alt="Admin is executed as a low privilege user" loading=lazy>
And just like that, the low privilege user is able to reach the <code>admin()</code> function despite being a low privilege user that can&rsquo;t make any changes to the system environment variable!</p><h2 id=conclusion>Conclusion</h2><p>In summary, Windows environment variables are wack. By combining the fact that user environment variables take precedence over system environment variables and that setting an environment variable to an empty string effectively deletes a variable, it&rsquo;s possible to make a system environment variable essentially disappear to anything that relies on environment variables! All without ever being an admin on the machine.</p></article></main></div></body></html>